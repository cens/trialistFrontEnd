<!DOCTYPE HTML>
<html lang="en">
  
  <head>
    <!-- The META information for parsing this file. -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=8"><!-- Force IE8 Mode because IE9 mode is unusable -->
    
    <!-- The title at the top of the page. -->
    <title>Trialist Setup</title>
    
    <!-- jQuery stuff -->
    <script src="js/jquery-1.9.0.min.js"></script>
    
    <!-- Bootstrap stuff -->
    <link href="https://fonts.googleapis.com/css?family=Limelight|Flamenco|Federo|Yesteryear|Josefin Sans|Spinnaker|Sansita One|Handlee|Droid Sans|Oswald:400,300,700" media="screen" rel="stylesheet" type="text/css" />
    <link href="bootstrap/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="bootstrap/css/bootstrap-responsive.min.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="bootstrap/js/bootstrap.min.js"></script>
    
    <!-- CSS Stuff -->
    <link href="css/UserSetup.css" media="screen" rel="stylesheet" type="text/css" />
    
    <!-- Wicked Good XPath -->
    <script src="js/wgxpath.install.js"></script>
  </head>
  
  <body>
    <!-- 
        This JavaScript should be run before any of the page is rendered. 
     -->
    <script type="text/javascript">
        /**
         * Retrieves a cookie's value.
         */
        function getCookie(name)
        {
            var i,x,y,ARRcookies=document.cookie.split(";");
            for(i = 0; i < ARRcookies.length; i++)
            {
                x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
                y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
                x=x.replace(/^\s+|\s+$/g,"");
                if (x == name)
                {
                    return unescape(y);
                }
            }
        }
        
        /**
         * Redirects the user to the login page.
         */
        function redirectToLogin() {
            <!--
            document.location = "/";
            //-->
        }
        
        /**
         * Retrieves the authentication token cookie or redirects the user to
         * the login page.
         *
         * @return The user's authentication token or null if no authentication
         *         token exists.
         */
        function getAuthToken() {
            // Attempt to retrieve the authentication token.
            var authToken = getCookie("auth_token");
            
            // If the token is missing, redirect the user back to the login
            // page.
            if(
                (authToken === null) ||
                (typeof authToken === "undefined") ||
                (authToken === ""))
            {
                // Set the authentication token to null;
                authToken = null;
                
                // Send the user to the login page.
                redirectToLogin();
            }
            
            // Return whatever we have as the authentication token.
            return authToken;
        }
        
        // Check for the authentication token before loading the page. If it
        // doesn't exist, we will be redirected to the homepage before any of
        // the UI elements are rendered.
        getAuthToken();
    
        // Install the Wicked Good XPath library.
        wgxpath.install();
    </script>
    <div class="container">
      <div id="alertModal" class="modal hide fade">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h3 id="alertHeader"></h3>
        </div>
        <div class="modal-body">
          <p id="alertInfo"></p>
        </div>
      </div>
      <div class="container-fluid">
        <div class="row-fluid">
          <span class="span12">
            <div class="page-header">
              <h1>Trialist Setup</h1>
            </div>
          </span>
        </div>
      </div>
      <br />
      <br />
      <div>
        <form class="form-horizontal" action="#">
          <h3 class="heading heading-shaddow">Patient</h3>
        </form>
        <div class="well">
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Username:</label>
              <div class="controls">
                <select id="selectUser">
                  <option value="New User" selected="selected">New Patient</option>
                </select>
                <input id="inputNewUserUsername" class="textinput" type="text" placeholder="New Username" title="Must be at least 8 characters.">
              </div>
            </div>
          </form>
          <form class="form-horizontal" action="#">
            <div id="divNewUserPassword" class="control-group">
              <label class="control-label">Password:</label>
              <div class="control-group">
                <div class="controls">
                  <input id="inputNewUserPassword" class="textinput" type="password" placeholder="New User Password" title="Must be at least 4 characters.">
                  <input id="inputNewUserPasswordRetype" class="textinput" type="password" placeholder="Retype Password" title="Must be at least 4 characters.">
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div>
        <form class="form-horizontal" action="#">
          <h3 class="heading heading-shaddow">Study Setup
            <br>
          </h3>
        </form>
        <div class="well">
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Regimen:</label>
              <div id="regimen" class="controls">
              </div>
            </div>
          </form>
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Period Length:</label>
              <div class="controls">
                <select id="regimenDuration" select>
                </select>
              </div>
            </div>
          </form>
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Number of Cycles:</label>
              <div class="controls">
                <select id="regimenCycles">
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div>
        <form class="form-horizontal" action="#">
          <h3 class="heading heading-shaddow">Outcomes
            <br>
          </h3>
        </form>
        <div class="well">
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Primary Outcome:</label>
              <div class="controls">
                <select id="primaryOutcome" style="width: 100%;">
                </select>
              </div>
            </div>
          </form>
          <form class="form-horizontal" action="#">
            <div class="control-group">
              <label class="control-label">Optional Outcomes:</label>
              <div id="optionalOutcomes" class="controls">
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span4"></div>
        <div class="span4" style="padding-bottom: 20px">
          <button id="create" class="btn btn-large btn-block btn-success" type="button" onclick="create()">Create</button>
        </div>
      </div>
    </div>
    <div class="container-fluid container-fluid-footer">
      <div class="row-fluid">
        <span class="span6">
          <p class="logo-easel">@easelapp</p>
        </span>
        <span class="span6">
          <p class="logo-ohmage" align="right">Powered by ohmage</p>
        </span>
      </div>
    </div>
    <!--
        The page ends with all of the JavaScript which will speed up how
        quickly the page is rendered and shouldn't even be run until after all
        of the UI elements have been setup.
     -->
    <script type="text/javascript">
        // The list of radio buttons refrencing the regimen.
        var REGIMEN_RADIOS = [];
    
        // The maximum random value allowed, which should be set when reading
        // the campaign's contents.
        var MAX_RANDOM;
        
        // The list of required survey IDs.
        var REQUIRED_SURVEY_IDS_EFFECTIVENESS = 
            [
                'promisFourItemPainInterferenceShortForm',
                'promisThreeItemPainIntensityShortForm',
                'qualityOfLifeSurvey',
                'sleepDisturbanceSurvey'
            ];
        var REQUIRED_SURVEY_IDS_HARM = 
            [
                'constipationSurvey',
                'fatigueSurvey',
                'nauseaSurvey',
                'sleepinessSurvey'
            ];
        var REQUIRED_SURVEY_IDS = 
            [].concat(
                REQUIRED_SURVEY_IDS_EFFECTIVENESS,
                REQUIRED_SURVEY_IDS_HARM);
        // The list of optional survey ID elements, which should be added when
        // reading the campaign's contents.
        var OPTIONAL_SURVEY_ID_ELEMENTS = [];
        
        // The Trialist class' unique identifier.
        var CLASS_ID = "urn:class:Trialist";
        
        // The Trialist campaign's unique identifier.
        var CAMPAIGN_ID = "urn:campaign:trialist:2013022801";
        // The ID of the survey that contains all of the setup prompts.
        var SETUP_SURVEY_ID = "setup";
        // The prompt IDs from the setup survey.
        var PROMPT_ID_REGIMEN = "regimen";
        var PROMPT_ID_REGIMEN_DURATION = "regimenDuration";
        var PROMPT_ID_REGIMEN_CYCLES = "numberComparisonCycles";
        var PROMPT_ID_RANDOM = "random";
        var PROMPT_ID_PRIMARY_OUTCOME = "primaryOutcome";
        
        // Setup the "Select User" section.
        $("#selectUser")
           .change(
                function() 
                {
                    if(this.selectedIndex === 0)
                    {
                        $("#inputNewUserUsername").fadeIn(200);
                        $("#divNewUserPassword").fadeIn(200);
                    }
                    else
                    {
                        $("#inputNewUserUsername").fadeOut(200);
                        $("#divNewUserPassword").fadeOut(200); 
                    }
                }
            );
        
        // Add the tooltips to the new user input fields.
        $("#inputNewUserUsername")
            .tooltip(
                {
                    position: "center right",
                    offset: [-2, 10],
                    effect: "fade",
                    opacity: 0.7
                }
            );
        $("#inputNewUserPassword")
        .tooltip(
            {
                position: "center right",
                offset: [-2, 10],
                effect: "fade",
                opacity: 0.7
            }
        );
        $("#inputNewUserPasswordRetype")
        .tooltip(
            {
                position: "center right",
                offset: [-2, 10],
                effect: "fade",
                opacity: 0.7
            }
        );
        
        // Populate the page's UI elements.
        try {
            getUsers();
            getCampaignDefinition();
        }
        catch(e) {
            alertUser("Error", "An unknown error occurred: " + e);
        }
        
        /**
         * Converts an XML string into a DOM object.
         */
        function convertXmlStringToDomObject(xml) {
            var xmlDoc = null;
            
            if(window.DOMParser)
            {
                var parser = new DOMParser();
                xmlDoc = parser.parseFromString(xml, "text/xml");
            }
            else // Internet Explorer
            {
                xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                xmlDoc.async = false;
                xmlDoc.loadXML(xml); 
            }
            
            return xmlDoc;
        }

        /**
         * Runs the document.evaluate() method based on the current browser.
         */
        function evaluateXpath(root, node, expression) {
            var result;
            if(window.DOMParser)
            {
                result =
                    root
                        .evaluate(
                            expression,
                            node,
                            null, 
                            XPathResult.ANY_TYPE,
                            null);
            }
            else // Internet Explorer
            {
                result =
                    document
                        .evaluate(
                            expression,
                            node,
                            null, 
                            XPathResult.ANY_TYPE,
                            null);
            }
            return result;
        }
        
        /**
         * randomUUID.js - Version 1.0
         *
         * Copyright 2008, Robert Kieffer
         *
         * This software is made available under the terms of the Open Software License
         * v3.0 (available here: http://www.opensource.org/licenses/osl-3.0.php )
         *
         * The latest version of this file can be found at:
         * http://www.broofa.com/Tools/randomUUID.js
         *
         * For more information, or to comment on this, please go to:
         * http://www.broofa.com/blog/?p=151
         *
         * Create and return a "version 4" RFC-4122 UUID string.
         */
         function randomUUID() {
             var s = [], itoh = '0123456789ABCDEF';

             // Make array of random hex digits. The UUID only has 32 digits in it, but we
             // allocate an extra items to make room for the '-'s we'll be inserting.
             for (var i = 0; i <36; i++) s[i] = Math.floor(Math.random()*0x10);
            
             // Conform to RFC-4122, section 4.4
             s[14] = 4;  // Set 4 high bits of time_high field to version
             s[19] = (s[19] & 0x3) | 0x8;  // Specify 2 high bits of clock sequence

             // Convert to hex chars
             for (var i = 0; i <36; i++) s[i] = itoh[s[i]];
             
             // Insert '-'s
             s[8] = s[13] = s[18] = s[23] = '-';
            
             return s.join('');
        }
        
        /**
         * Uses some UI element to alert the user that something has happened.
         */
        function alertUser(header, info) {
            $("#alertHeader").text(header);
            $("#alertInfo").text(info);
            $("#alertModal").modal('show');
        }
        
        /**
         * Retrieves the list of users visible to this user via their classes.
         *
         * @return A JSON array of the users.
         */
        function getUsers() {
            // Build the failure function.
            var failure = function() {
                alertUser(
                    "Error Retrieving Users",
                    "There was an error retrieving the list of users.");
            } 
            // Build the success function.
            var success = function(data) {
                try {
                    // Check that we indicated success.
                    if(data['result'] === "success") {
                        // Connect to the list of users element in the HTML.
                        var userListElement = $("#selectUser");
                        
                        // Iterate over all of the classes.
                        for(var currClassId in data['data']) {
                            // We are only concerned with the Trialist class.
                            if(currClassId !== CLASS_ID) {
                                continue;
                            }
                            
                            // Get the current class object.
                            var classObject = data['data'][currClassId];
                            
                            // Iterate over all of the users in the current class.
                            for(var user in classObject['users']) {
                                userListElement
                                    .append(
                                        "<option value=\"" + user + "\">" +
                                           user +
                                           "</option>");
                            }
                        }
                    }
                    else {
                        var failureObject = data['errors'][0];
                        if(failureObject['code'] === "0200") {
                            redirectToLogin();
                        }
                        else {
                            throw "Error reading the data: " + 
                                    failureObject['text'];
                        }
                    }
                }
                catch(e) {
                    alertUser(
                        "Error Loading Users",
                        "There was an error loading the list of users: " + e);
                }
            }
            
            // Build the parameters and make the request.
            var authToken = getAuthToken();
            if(authToken != null) {
                var parameters = {
                        "client" : "TrialistWeb",
                        "auth_token" : authToken,
                        "class_urn_list" : CLASS_ID
                };
                $.post("/app/class/read", parameters, success).fail(failure);
            }
        }
        
        /**
         * Get the campaign definition.
         */
        function getCampaignDefinition() {
            // Build the failure function.
            var failure = function() {
                alertUser(
                    "Server Communication Error",
                    "There was an error while communicating with the server.");
            }
            // Build the success function.
            var success = function(data) {
                try {
                    // Check that we indicated success.
                    if(data['result'] === "success") {
                        // Iterate over all of the campaigns.
                        for(var currCampaignId in data['data']) {
                            // We are only concerned with the Trialist
                            // campaign.
                            if(currCampaignId !== CAMPAIGN_ID) {
                                continue;
                            }
                            
                            // Get a handle for all of the necessary objects.
                            var regimen = $("#regimen");
                            var regimenDuration = $("#regimenDuration");
                            var regimenCycles = $("#regimenCycles");
                            
                            var primaryOutcome = $("#primaryOutcome");
                            var optionalOutcomes = $("#optionalOutcomes");
                            
                            // Get the Trialist campaign XML.
                            var xml = data['data'][currCampaignId]['xml'];
                            var xmlObject = convertXmlStringToDomObject(xml);
                            
                            // Get the configuration surveys.
                            var setupSurveys = 
                                evaluateXpath(
                                    xmlObject,
                                    xmlObject,
                                    '/campaign/surveys/survey[id="' + 
                                        SETUP_SURVEY_ID + 
                                        '"]');
                            if(setupSurveys.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                                throw "The setup survey is not an XML node.";
                            }
                            
                            // Get the single configuration survey.
                            var setupSurvey = setupSurveys.iterateNext();
                            if(setupSurvey === null) {
                                throw "The setup survey is missing.";
                            }
                            
                            // Populate the regimen HTML select.
                            createRadioButtonsFromPromptProperties(
                                    xmlObject,
                                    setupSurvey,
                                    PROMPT_ID_REGIMEN,
                                    regimen,
                                    "regimen");
                            
                            // Populate the duration.
                            createSelectOptionsFromPromptProperties(
                                    xmlObject,
                                    setupSurvey,
                                    PROMPT_ID_REGIMEN_DURATION,
                                    regimenDuration);
                            
                            // Populate the number of cycles.
                            createSelectOptionsFromPromptProperties(
                                    xmlObject,
                                    setupSurvey,
                                    PROMPT_ID_REGIMEN_CYCLES,
                                    regimenCycles,
                                    OPTIONAL_SURVEY_ID_ELEMENTS);
                            
                            // Populate the number of cycles.
                            MAX_RANDOM =
                                getNumChoices(
                                    xmlObject,
                                    setupSurvey,
                                    PROMPT_ID_RANDOM);
                            
                            // Create a choice for the "primary" outcome.
                            populateSelectFromSurveys(
                                xmlObject,
                                REQUIRED_SURVEY_IDS_EFFECTIVENESS,
                                primaryOutcome);
                            
                            // Get the list of surveys and their descriptions
                            // and add them to the outcomes.
                            var otherSurveys = 
                                evaluateXpath(
                                    xmlObject,
                                    xmlObject,
                                    '/campaign/surveys/survey[id!="' + 
                                        SETUP_SURVEY_ID + 
                                        '"]');
                            if(otherSurveys.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                                throw "Another survey is not an XML node.";
                            }
                            
                            // Create the outcome check boxes from the surveys.
                            createCheckBoxesFromSurveys(
                                xmlObject,
                                optionalOutcomes,
                                otherSurveys,
                                REQUIRED_SURVEY_IDS);
                        }
                    }
                    else {
                        var failureObject = data['errors'][0];
                        if(failureObject['code'] === "0200") {
                            redirectToLogin();
                        }
                        else {
                            throw "Error reading the data: " +
                                    failureObject['text'];
                        }
                    }
                }
                catch(e) {
                    alertUser(
                        "Error Populating the Page",
                        "There was an error populating the page: " + 
                            e.toString());
                }
            }
            
            // Build the parameters and make the request.
            var authToken = getAuthToken();
            if(authToken != null) {
                var parameters = {
                        "client" : "TrialistWeb",
                        "auth_token" : authToken,
                        "campaign_urn_list" : CAMPAIGN_ID,
                        "output_format" : "long"
                };
                $.post("/app/campaign/read", parameters, success, "json")
                    .fail(failure);
            }
        }
        
        /**
         * Finds a specific prompt in a survey and populate the given HTML div
         * with the properties of this prompt. This prompt must be a [custom]
         * single or multi choice prompt.
         */
        function createRadioButtonsFromPromptProperties(root, survey, promptId, div, name) {
            // Get the properties for the given prompt in the given survey.
            var properties = getPropertiesFromPrompt(root, survey, promptId);
            
            // Using the properties, populate the HTML div.
            populateRadioFromProperties(root, div, properties, name);
        }
        
        /**
         * Finds a specific prompt in a survey and populates the given HTML
         * select with the properties of this prompt. This prompt must be a
         * [custom] single or multi choice prompt.
         */
        function createSelectOptionsFromPromptProperties(root, survey, promptId, select) {
            // Get the properties for the given prompt in the given survey.
            var properties = getPropertiesFromPrompt(root, survey, promptId);
            
            // Using the properties, populate the HTML select.
            populateSelectFromProperties(root, select, properties);
        }
        
        /**
         * Drills down on a survey to find the given prompt. Then, it drills
         * down on the prompt to get its properties. Those properties XML
         * elements are returned.
         *
         * @param survey An XML element referencing the survey.
         *
         * @param promptId The prompt ID whose properties are desired.
         *
         * @return An XML object that references all of the "property" tags.
         */
        function getPropertiesFromPrompt(root, survey, promptId) {
            // Get the prompt elements.
            var prompts =
                evaluateXpath(
                    root,
                    survey,
                    './/prompt[id="' + promptId + '"]');
            if(prompts.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                throw "The " + promptId + " prompt is not an XML node.";
            }
            
            // Get the singular prompt element.
            var prompt = prompts.iterateNext();
            if(prompt === null) {
                throw "The " + promptId + " prompt is missing.";
            }
            
            // Get the prompt's properties.
            var properties =
                evaluateXpath(
                    root,
                    prompt,
                    './/property');
            if(properties.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                throw "The properties for " + promptId + " are not XML nodes.";
            }
            
            // Return the list of properties.
            return properties;
        }
        
        /**
         * Populates a HTML select tag with the given single choice prompt
         * properties.
         */
        function populateSelectFromProperties(root, select, properties) {
            var currProperty = null;
            while((currProperty = properties.iterateNext()) !== null) {
                // XPath to the key element.
                var keyElements =
                    evaluateXpath(
                        root,
                        currProperty,
                        './key');
                if(keyElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The property key is not an HTML object.";
                }
                
                // Get the key element.
                var keyElement = keyElements.iterateNext();
                if(keyElement === null) {
                    throw "The property is missing its key.";
                }
                
                // Get the key value.
                var key = keyElement.textContent;
                
                // XPath to the label element.
                var labelElements =
                    evaluateXpath(
                        root,
                        currProperty,
                        './label');
                if(labelElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The property key is not an HTML object: " + key;
                }
                
                // Get the label element.
                var labelElement = labelElements.iterateNext();
                if(labelElement === null) {
                    throw "The property is missing its label: " + key;
                }
                
                // Get the label value.
                var label = labelElement.textContent;
                
                // Add the value to the select's choices.
                select
                    .append(
                        '<option value="' + 
                            key + 
                            '">' + 
                            label + 
                        '</option>');
            }
            
            // Reset the selected index to -1, so that the user must explicitly
            // choose an option.
            select.prop('selectedIndex', -1);
        }
        
        /**
         * Populates a HTML select tag with the given surveys' title and
         * description.
         */
        function populateSelectFromSurveys(root, surveyIds, select) {
            // Cycles through the survey IDs.
            for(var i = 0; i < surveyIds.length; i++) {
                // Get the survey ID.
                var surveyId = surveyIds[i];
                
                // Get the survey XML nodes.
                var surveyNodes =
                    evaluateXpath(
                        root,
                        root,
                        '/campaign/surveys/survey[id="' + surveyId + '"]');
                if(surveyNodes.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The survey is not an HTML object: " + surveyId;
                }

                // Get the survey XML nodes.
                var currSurvey = surveyNodes.iterateNext();
                if(currSurvey === null) {
                    throw "The survey does not exist: " + surveyId;
                }
                
                // XPath to the name element.
                var titleElements =
                    evaluateXpath(
                        root,
                        currSurvey,
                        './title');
                if(titleElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The title is not an HTML object.";
                }
                
                // Get the name element.
                var titleElement = titleElements.iterateNext();
                if(titleElement === null) {
                    throw "The survey is missing its title.";
                }
                
                // Get the name value.
                var title = titleElement.textContent;
                
                // XPath to the description element.
                var descriptionElements =
                    evaluateXpath(
                        root,
                        currSurvey,
                        './description');
                if(descriptionElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The description is not an HTML object: " + title;
                }
                
                // Get the description element if given; otherwise, set the 
                // description to null.
                var description = null;
                var descriptionElement = descriptionElements.iterateNext();
                if(descriptionElement !== null) {
                    description = descriptionElement.textContent;
                }
                
                // Add the value to the select's choices.
                select
                    .append(
                        '<option value="' + 
                            surveyId + 
                            '">' + 
                                title + 
                                ((description === null) ? 
                                    '' : ' (' + description + ')') +
                        '</option>');
            }
            
            // Reset the selected index to -1, so that the user must explicitly
            // choose an option.
            select.prop('selectedIndex', -1);
        }
        
        /**
         * Populates a HTML div tag with the given single choice prompt
         * properties as radio buttons.
         */
        function populateRadioFromProperties(root, div, properties, name) {
            var currProperty = null;
            while((currProperty = properties.iterateNext()) !== null) {
                // XPath to the key element.
                var keyElements =
                    evaluateXpath(
                        root,
                        currProperty,
                        './key');
                if(keyElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The property key is not an HTML object.";
                }
                
                // Get the key element.
                var keyElement = keyElements.iterateNext();
                if(keyElement === null) {
                    throw "The property is missing its key.";
                }
                
                // Get the key value.
                var key = keyElement.textContent;
                
                // XPath to the label element.
                var labelElements =
                    evaluateXpath(
                        root,
                        currProperty,
                        './label');
                if(labelElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The property key is not an HTML object: " + key;
                }
                
                // Get the label element.
                var labelElement = labelElements.iterateNext();
                if(labelElement === null) {
                    throw "The property is missing its label: " + key;
                }
                
                // Get the label value.
                var label = labelElement.textContent;
                
                // Create the radio.
                var radio = 
                    $('<input ' +
                          'type="radio" ' +
                          'name="' + name + '" ' +
                          'value="' + key + '">' +
                              label +
                      '</input>');
                
                // Add the radio to the list of regimens.
                REGIMEN_RADIOS.push(radio);
                
                // Build the entire checkbox option.
                var entireOption =
                    $('<label class="radio"></label>')
                        .append(radio);
                
                // Add the entire option to the div.
                div.append(entireOption);
            }
        }
        
        /**
         * Populates a HTML select tag with the given single choice prompt
         * properties.
         */
        function createCheckBoxesFromSurveys(root, div, surveys, ignoredIds, elements) {
            var currSurvey = null;
            
            if((typeof ignoredIds === "undefined") || (ignoredIds === null)) {
                ignoredIds = [];
            }
            
            while((currSurvey = surveys.iterateNext()) !== null) {
                // XPath to the ID element.
                var idElements =
                    evaluateXpath(
                        root,
                        currSurvey,
                        './id');
                if(idElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The ID is not an HTML object.";
                }
                
                // Get the ID element.
                var idElement = idElements.iterateNext();
                if(idElement === null) {
                    throw "The survey is missing its ID.";
                }
                
                // Get the ID value.
                var id = idElement.textContent;
                
                // If the ID is in the list of IDs to ignore, skip it.
                if(ignoredIds.indexOf(id) >= 0) {
                    continue;
                }
                
                // XPath to the name element.
                var titleElements =
                    evaluateXpath(
                        root,
                        currSurvey,
                        './title');
                if(titleElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The title is not an HTML object.";
                }
                
                // Get the name element.
                var titleElement = titleElements.iterateNext();
                if(titleElement === null) {
                    throw "The survey is missing its title.";
                }
                
                // Get the name value.
                var title = titleElement.textContent;
                
                // XPath to the description element.
                var descriptionElements =
                    evaluateXpath(
                        root,
                        currSurvey,
                        './description');
                if(descriptionElements.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                    throw "The description is not an HTML object: " + title;
                }
                
                // Get the description element if given; otherwise, set the 
                // description to null.
                var description = null;
                var descriptionElement = descriptionElements.iterateNext();
                if(descriptionElement !== null) {
                    description = descriptionElement.textContent;
                }
                
                // Create the checkbox.
                var checkbox = $('<input type="checkbox" value="' + id + '">');
                
                // Add the checkbox to the list of optional elements.
                OPTIONAL_SURVEY_ID_ELEMENTS.push(checkbox);
                
                // Build the entire checkbox option.
                var entireOption =
                    $('<label class="checkbox"></label>')
                        .append(checkbox)
                        .append(
                            '<span class="">' + 
                                title + 
                                ((description === null) ? 
                                        '' : ' (' + description + ')') +
                            '</span>');
                
                // Add the entire option to the div.
                div.append(entireOption);
            }
        }
        
        /**
         * Gets the number of properties, i.e. the number of choices. The 
         * prompt must be a single_choice, single_choice_custom, multi_choice,
         * or multi_choice_custom prompt.
         */
        function getNumChoices(root, survey, promptId) {
            // Get the prompt elements.
            var prompts =
                evaluateXpath(
                    root,
                    survey,
                    './/prompt[id="' + promptId + '"]');
            if(prompts.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                throw "The " + promptId + " prompt is not an XML node.";
            }
            
            // Get the singular prompt element.
            var prompt = prompts.iterateNext();
            if(prompt === null) {
                throw "The " + promptId + " prompt is missing.";
            }
            
            // Get the prompt's properties.
            var properties =
                evaluateXpath(
                    root,
                    prompt,
                    './/property');
            if(properties.resultType !== XPathResult.UNORDERED_NODE_ITERATOR_TYPE) {
                throw "The properties for " + promptId + " are not XML nodes.";
            }
            
            // Set the count to 0.
            var count = 0;
            while(properties.iterateNext()) {
                count++;
            }
            
            // Return the count.
            return count;
        }
        
        /**
         * Makes the call to the campaign assignment API.
         */
        function create() {
            try {
                // Create the username and passowrd variables.
                var username, password = null;
                
                // Get the HTML element used to select the user.
                var selectUserElement = $("#selectUser");
                
                // If this is a new user, ensure that the two password fields
                // match.
                // Developer's note: Why "get(0)"? Because it works; other than
                // that, I have no idea.
                if(selectUserElement.get(0).selectedIndex === 0) {
                    // Get the username and password elements.
                    var usernameElement = $("#inputNewUserUsername");
                    var passwordElement = $("#inputNewUserPassword")
                    
                    // Get the username and password values.
                    username = usernameElement.val();
                    password = passwordElement.val();
                    
                    // If the username is null or empty, alert the user.
                    if((username === null) || (username.length === 0)) {
                        alertUser(
                            "Missing Username",
                            "A username must be given for the new user.");
                        usernameElement.focus();
                        return;
                    }
                    // If the password is null or empty, alert the user.
                    else if((password === null) || (password.length === 0)) {
                        alertUser(
                            "Missing Password",
                            "A password must be given for the new user.");
                        passwordElement.focus();
                        return;
                    }
                    // If the passwords don't match, alert the user.
                    if(password !== $("#inputNewUserPasswordRetype").val()) {
                        alertUser(
                            "Passwords Do Not Match",
                            "The two passwords do not match.");
                        passwordElement.focus();
                        return;
                    }
                }
                // Otherwise, get the user's username.
                else {
                    username = selectUserElement.val();
                }
                
                // Cycle through the regimens, find the one that is checked,
                // and set is value as the regimen value.
                var regimen = null;
                for(var i = 0; i < REGIMEN_RADIOS.length; i++) {
                    // Get the current regimen radio.
                    var regimenRadio = REGIMEN_RADIOS[i];
                    
                    // If it is checked, set it as the regimen response value. 
                    if(regimenRadio.is(":checked")) { 
                        regimen = regimenRadio.val();
                    }
                }
                if(regimen === null) {
                    alertUser(
                        "No Regimen Selected",
                        "Please choose a regimen.");
                    return;
                }
                
                // Get the regimen duration value.
                var regimenDuration = $("#regimenDuration").val();
                if(regimenDuration === null) {
                    alertUser(
                        "No Length Selected",
                        "Please choose a period length.");
                    return;
                }
                
                // Get the number of regimen cycles.
                var regimenCycles = $("#regimenCycles").val();
                if(regimenCycles === null) {
                    alertUser(
                        "No Cycles Selected",
                        "Please choose a number of cycles.");
                    return;
                }
                
                // Generate a random value for the pattern.
                var regimenRandom =
                    Math.floor(Math.random() * 1000 * MAX_RANDOM) % MAX_RANDOM;
                
                // Get the primary outcome text.
                var primaryOutcome = $("#primaryOutcome").val();
                if(primaryOutcome === null) {
                    alertUser(
                        "No Primary Outcome Selected",
                        "Please choose a primary outcome.");
                    return;
                }
                
                // Build the survey response.
                var surveyResponse = {
                        "survey_key" : randomUUID(),
                        "time" : (new Date()).getTime(),
                        "timezone" : (new Date()).toTimeString().split('(')[1].split(')')[0],
                        "location_status" : "unavailable",
                        "survey_id" : SETUP_SURVEY_ID,
                        "survey_launch_context" : {
                            "launch_time" : (new Date()).getTime(),
                            "launch_timezone" : (new Date()).toTimeString().split('(')[1].split(')')[0],
                            "active_triggers" : []
                        },
                        "responses" : [
                            {
                                "prompt_id" : PROMPT_ID_REGIMEN,
                                "value" : regimen
                            },
                            {
                                "prompt_id" : PROMPT_ID_REGIMEN_DURATION,
                                "value" : regimenDuration
                            },
                            {
                                "prompt_id" : PROMPT_ID_REGIMEN_CYCLES,
                                "value" : regimenCycles
                            },
                            {
                                "prompt_id" : PROMPT_ID_RANDOM,
                                "value" : regimenRandom
                            },
                            {
                                "prompt_id" : PROMPT_ID_PRIMARY_OUTCOME,
                                "value" : primaryOutcome
                            }
                        ]
                };
                
                // The survey responses must be an array.
                var surveyResponses = [surveyResponse];
                
                // Get the list of outcomes, which is the default outcomes plus
                // the selected optional outcomes.
                var surveyIds = REQUIRED_SURVEY_IDS.slice();
                for(var i = 0; i < OPTIONAL_SURVEY_ID_ELEMENTS.length; i++) {
                    // Get the current survey ID element.
                    var optionalSurveyIdElement = 
                        OPTIONAL_SURVEY_ID_ELEMENTS[i];
                    
                    // If it is checked, add it to the list of survey IDs.
                    if(optionalSurveyIdElement.is(":checked")) { 
                        surveyIds.push(optionalSurveyIdElement.val());
                    }
                }
                
                // Create the failure function.
                var failure = function() {
                    alertUser(
                        "Creation Failure",
                        "The server returned an unexpected error.");
                }
                // Create the success function.
                var success = function(data) {
                    // Check that we indicated success.
                    if(data['result'] === "success") {
                        alertUser(
                            "Success",
                            "The user was successfully setup.");
                    }
                    else {
                        var failureObject = data['errors'][0];
                        if(failureObject['code'] === "0200") {
                            redirectToLogin();
                        }
                        else {
                            alertUser(
                                "Error",
                                "There was an error setting up the user: " + 
                                    failureObject['text']);
                        }
                    }
                }
                
                // Submit the request.
                var authToken = getAuthToken();
                if(authToken != null) {
                    // Build the survey IDs string.
                    var surveyIdsString = '';
                    var firstPass = true;
                    for(var i = 0; i < surveyIds.length; i++) {
                        if(firstPass) {
                            firstPass = false;
                        }
                        else {
                            surveyIdsString = surveyIdsString + ",";
                        }
                        
                        surveyIdsString = surveyIdsString + surveyIds[i];
                    }
                    
                    // Create the parameters list.
                    var parameters = {
                            "client" : "TrialistWeb",
                            "auth_token" : authToken,
                            "username" : username,
                            "class_urn" : CLASS_ID,
                            "campaign_urn" : CAMPAIGN_ID,
                            "survey_id_list" : surveyIdsString,
                            "surveys" : JSON.stringify(surveyResponses)
                    };
                    // Add the password if we are creating a new user.
                    if(password !== null) {
                        parameters['new_password'] = password;
                    }
                    // Make the request.
                    $.post(
                        "/app/campaign/assign",
                        parameters,
                        success)
                        .fail(failure);
                }
            }
            catch(e) {
                alertUser(
                    "Error",
                    "There was an error setting up the user: " + e);
            }
        }
    </script>
  </body>
</html>